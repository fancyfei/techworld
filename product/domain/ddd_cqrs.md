# DDD中的设计模式-CQRS

CQRS（Command Query Responsibility Segregation），指的是将 command 与 query 分离的一种模式。此模式将系统中的操作分为命令和查询两类。

- command，是对会引起数据发生变化操作的总称，如日常遇到的新增，更新，删除这些操作，都是命令。
- query，查询。

CQRS 在 DDD 中是一种常常被提及的模式，将领域模型与查询功能进行分离，让一些复杂的查询摆脱领域模型的限制，以更为简单的 DTO 形式展现查询结果，同时可以为查询与命令操作分别设计数据存储结构。

## 模式实现

![ddd_crqs](ddd_crqs.png)

本质上，CQRS也是一种读写分离的机制。有两种实现方式：

- 简单模式，同一数据库，查询与命令两种操作只在上层代码分离。当然也可以通过主备数据库简单分离数据库。
- 完整模式，不同数据库，不同代码，甚至不同服务，查询用读库，命令使用写库，数据一般通过Domain Event进行同步。并且一般是异步进行，做数据的最终一致性。

## 问题及解决方案

- **多个数据源的事务**
  多数据源进行事务处理，如果事务同步则会引发系统性能低下问题，如果异步则可能数据不一致问题。数据完整性比较高的情况下，不适合应用CRQS模式。一般情况下，需要业务逻辑上面对最终一致性的问题。
- **数据读写分离**
  读写分离有多种实现方案，如果同类型的数据库，常见的是通过数据库自身的主从同步机制可以完成。如果是不同类型的数据库或者不是主从模式，则需要使用事件进行同步。
- **查询性能优化**
  查询的性能优化一般可以选择加入缓存，如Redis。对于海量的数据查询需求，可能需要使用Nosql数据库存储加上热点数据缓存等方式。海量且复杂的查询可以使用文本型搜索技术如ElasticSearch、Lucene等。
- **查询简化**
  查询一般情况下，不需要领域模型这么重的结构，不需要Domain层，仅使用DTO做数据传输。
- **事件重复消费**
  消息驱动的系统，要尽量避免消息的重复消费，常见方案便是幂等处理。处理方式又分在数据层面检查复杂，如业务主键重复检查等，另外一个是在消息层面检查消息是否重复消费，如给消息一个唯一ID，保证不重复处理。
- **Event Sourcing（事件溯源）**
  持久化事件，记录事件日志或用于回放，就可以采取事件溯源。事件只会按时间序追加存储，不会修改或删除。使用事件溯源方式，可以很好地应对复杂的领域模型，但是简单的业务或者实时系统就不适合了。



